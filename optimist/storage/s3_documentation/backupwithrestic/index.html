<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico" type="image/x-icon"><title>Secure Backups with Restic and Rclone | Documentation</title><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Secure Backups with Restic and Rclone" /><meta property="og:locale" content="en" /><meta name="description" content="Restic is a very simple and powerful file-level backup solution, which is rapidly gaining popularity. It can be used in combination with S3 which makes it a great tool to use with Optimist." /><meta property="og:description" content="Restic is a very simple and powerful file-level backup solution, which is rapidly gaining popularity. It can be used in combination with S3 which makes it a great tool to use with Optimist." /><link rel="canonical" href="/optimist/storage/s3_documentation/backupwithrestic/" /><meta property="og:url" content="/optimist/storage/s3_documentation/backupwithrestic/" /><meta property="og:site_name" content="Documentation" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-08-29T14:38:18+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Secure Backups with Restic and Rclone" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-29T14:38:18+00:00","datePublished":"2024-08-29T14:38:18+00:00","description":"Restic is a very simple and powerful file-level backup solution, which is rapidly gaining popularity. It can be used in combination with S3 which makes it a great tool to use with Optimist.","headline":"Secure Backups with Restic and Rclone","mainEntityOfPage":{"@type":"WebPage","@id":"/optimist/storage/s3_documentation/backupwithrestic/"},"url":"/optimist/storage/s3_documentation/backupwithrestic/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-copy" viewBox="0 0 16 16"><title>Copy</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"><title>Copied</title><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"><path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg><div class="side-bar"><div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"><svg class="site-logo" width="44" height="51" viewBox="0 0 44 51" fill="none" focusable="false" xmlns="http://www.w3.org/2000/svg"><path d="M21.9985 0L32.9985 6.35022L38.1104 9.30107L31.1561 13.3166L29.5221 12.3727L21.9985 8.02952L14.4749 12.3727L6.95126 16.716V25.4024V34.0888L14.4749 38.432L21.9985 42.7753L29.5221 38.432L44 30.0733V38.1043L33 44.4561L22 50.8063L11 44.4561L0 38.1043V25.4024V12.7004L11 6.34871L21.9985 0ZM21.9985 34.6597L29.1657 30.5218L36.4764 26.3009L44 21.9577V13.9267L33 20.2784L22 26.6301V34.6597H21.9985ZM28.9543 30.6441L29.1672 30.5218L28.9543 30.6441Z" fill="#111" /><path d="M21.9985 34.6588L29.1658 30.5209L36.4764 26.3L44 21.9568V13.9258L33 20.2775L22 26.6292V34.6588H21.9985ZM28.9543 30.6432L29.1673 30.5209L28.9543 30.6432Z" fill="#111" /> </svg><div class="rp_title"> Documentation</div></a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"></ul><div class="nav-category">Elastic Cloud Enterprise</div><ul class="nav-list"><li class="nav-list-item"><a href="/ece/intro" class="nav-list-link">Introduction</a><li class="nav-list-item"><a href="/ece/shipdata/" class="nav-list-link">Shipping data to Elastic</a><li class="nav-list-item"><a href="/ece/updateilm/" class="nav-list-link">Changing Lifecycle Policies</a></ul><div class="nav-category">GKS</div><ul class="nav-list"></ul><div class="nav-category">Oncite Open Edition</div><ul class="nav-list"><li class="nav-list-item"><a href="/edge/productoverview/" class="nav-list-link">Product Overview</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Operations Center category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/edge/operationscenter/" class="nav-list-link">Operations Center</a><ul class="nav-list"><li class="nav-list-item "><a href="/edge/operationscenter/vpnaas/" class="nav-list-link">VPN as a Service</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Openstack category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/edge/openstack/" class="nav-list-link">Openstack</a><ul class="nav-list"><li class="nav-list-item "><a href="/edge/openstack/create_vm/" class="nav-list-link">Create VM</a></ul><li class="nav-list-item"><a href="/edge/faq/" class="nav-list-link">FAQ</a></ul><div class="nav-category">Optimist</div><ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Guided Tour category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/optimist/guided_tour/" class="nav-list-link">Guided Tour</a><ul class="nav-list"><li class="nav-list-item "><a href="/optimist/guided_tour/step01/" class="nav-list-link">01: The Horizon (Dashboard)</a><li class="nav-list-item "><a href="/optimist/guided_tour/step02/" class="nav-list-link">02: Create an SSH-Key with the Horizon (Dashboard)</a><li class="nav-list-item "><a href="/optimist/guided_tour/step03/" class="nav-list-link">03: Spawn a new Stack</a><li class="nav-list-item "><a href="/optimist/guided_tour/step04/" class="nav-list-link">04: Your way to the console</a><li class="nav-list-item "><a href="/optimist/guided_tour/step05/" class="nav-list-link">05: An overview of the most important OpenStackClient commands</a><li class="nav-list-item "><a href="/optimist/guided_tour/step06/" class="nav-list-link">06: Create and use your own SSH-Key</a><li class="nav-list-item "><a href="/optimist/guided_tour/step07/" class="nav-list-link">07: The first VM</a><li class="nav-list-item "><a href="/optimist/guided_tour/step08/" class="nav-list-link">08: Delete the first VM</a><li class="nav-list-item "><a href="/optimist/guided_tour/step09/" class="nav-list-link">09: Security Groups</a><li class="nav-list-item "><a href="/optimist/guided_tour/step10/" class="nav-list-link">10: Get access to the Internet; Create a network</a><li class="nav-list-item "><a href="/optimist/guided_tour/step11/" class="nav-list-link">11: Prepare access to the Internet; Add IPv6 to your network</a><li class="nav-list-item "><a href="/optimist/guided_tour/step12/" class="nav-list-link">12: A usable VM</a><li class="nav-list-item "><a href="/optimist/guided_tour/step13/" class="nav-list-link">13: The structured way to create an instance (with stacks)</a><li class="nav-list-item "><a href="/optimist/guided_tour/step14/" class="nav-list-link">14: Your first steps with HEAT</a><li class="nav-list-item "><a href="/optimist/guided_tour/step15/" class="nav-list-link">15: The first heat template</a><li class="nav-list-item "><a href="/optimist/guided_tour/step16/" class="nav-list-link">16: Get to know HEAT better</a><li class="nav-list-item "><a href="/optimist/guided_tour/step17/" class="nav-list-link">17: The network in Heat</a><li class="nav-list-item "><a href="/optimist/guided_tour/step18/" class="nav-list-link">18: Making your VM reachable via IPv4</a><li class="nav-list-item "><a href="/optimist/guided_tour/step19/" class="nav-list-link">19: Add IPv6 to your template</a><li class="nav-list-item "><a href="/optimist/guided_tour/step20/" class="nav-list-link">20: Build multiple VMs with HEAT</a><li class="nav-list-item "><a href="/optimist/guided_tour/step21/" class="nav-list-link">21: Start a VM with an SSD volume</a><li class="nav-list-item "><a href="/optimist/guided_tour/step22/" class="nav-list-link">22: Create a DNS record in Designate</a><li class="nav-list-item "><a href="/optimist/guided_tour/step23/" class="nav-list-link">23: Object Storage (S3 compatible)</a></ul><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Networking category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/optimist/networking/" class="nav-list-link">Networking</a><ul class="nav-list"><li class="nav-list-item "><a href="/optimist/networking/port_forwarding/" class="nav-list-link">Port Forwarding on Floating IPs</a><li class="nav-list-item "><a href="/optimist/networking/shared_networks/" class="nav-list-link">Shared Networks</a><li class="nav-list-item "><a href="/optimist/networking/vpnaas/" class="nav-list-link">VPN as a Service</a><li class="nav-list-item "><a href="/optimist/networking/octavia_loadbalancer/" class="nav-list-link">Octavia Loadbalancers</a></ul><li class="nav-list-item active"><button class="nav-list-expander btn-reset" aria-label="toggle items in Storage category" aria-pressed="true"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/optimist/storage/" class="nav-list-link">Storage</a><ul class="nav-list"><li class="nav-list-item active"><button class="nav-list-expander btn-reset" aria-label="toggle items in S3 Compatible Object Storage category" aria-pressed="true"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/optimist/storage/s3_documentation/" class="nav-list-link">S3 Compatible Object Storage</a><ul class="nav-list"><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/createanduses3credentials/" class="nav-list-link">Create and Use S3 Credentials</a><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/createanddeletebucket/" class="nav-list-link">Create and Delete a Bucket</a><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/uploadanddeleteobject/" class="nav-list-link">Upload and delete an object</a><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/versioning/" class="nav-list-link">Enable and Disable Versioning, and Delete a versioned object</a><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/security/" class="nav-list-link">S3 Security</a><li class="nav-list-item "> <a href="/optimist/storage/s3_documentation/swiftservestaticwebsite/" class="nav-list-link">Swift - Serving a Static Website</a><li class="nav-list-item active"> <a href="/optimist/storage/s3_documentation/backupwithrestic/" class="nav-list-link active">Secure Backups with Restic and Rclone</a></ul><li class="nav-list-item "><a href="/optimist/storage/localstorage/" class="nav-list-link">Localstorage</a></ul><li class="nav-list-item"><a href="/optimist/faq/" class="nav-list-link">FAQ</a><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Specifications category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/optimist/specs/" class="nav-list-link">Specifications</a><ul class="nav-list"><li class="nav-list-item "><a href="/optimist/specs/flavor_specification/" class="nav-list-link">Flavor Specifications</a><li class="nav-list-item "><a href="/optimist/specs/default_quota/" class="nav-list-link">Default Quotas</a><li class="nav-list-item "><a href="/optimist/specs/application_credentials/" class="nav-list-link">Application Credentials</a><li class="nav-list-item "><a href="/optimist/specs/volume_specification/" class="nav-list-link">Volume Specifications</a><li class="nav-list-item "><a href="/optimist/specs/images/" class="nav-list-link">Images</a><li class="nav-list-item "><a href="/optimist/specs/shelving_instances/" class="nav-list-link">Shelving Instances</a></ul><li class="nav-list-item"><a href="/optimist/changelog/" class="nav-list-link">Changelog</a></ul></nav><a href="https://gec.io/company/zertifizierungen/" target="_blank"><div style="display: flex; justify-content: space-between; padding: 16px; width: 280px"> <img id="isoimage" src="https://s3.es1.fra.optimist.gec.io/swift/v1/static/docs/iso9001.webp" alt="ISO 9001" style="flex-grow: 1; object-fit: contain; height: 1.5rem; "> <img src="https://s3.es1.fra.optimist.gec.io/swift/v1/static/docs/iso27001.webp" alt="ISO 27001" style="flex-grow: 1; object-fit: contain; height: 1.5rem; "> <img src="https://s3.es1.fra.optimist.gec.io/swift/v1/static/docs/isae-3402-t2certified-logo-cmyk1-page-001_rdax_565x282_100.webp" alt="ISAE 3402" style="flex-grow: 1; object-fit: contain; height: 1.5rem;"></div></a> <script language="javascript" type="text/javascript"> var d = new Date(); document.getElementById("isoimage").src = "https://s3.es1.fra.optimist.gec.io/swift/v1/static/docs/iso9001.webp?ver=" + d.getTime(); </script></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search" role="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Documentation" aria-label="Search Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><ul class="language-list"><li class="language-list-item"> <a class="language-list-link active" href=" /optimist/storage/s3_documentation/backupwithrestic/ " >English</a ><li class="language-list-item"> <a class="language-list-link" href=" /de/optimist/storage/s3_documentation/backupwithrestic/ " >Deutsch</a ></ul></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/optimist/storage/">Storage</a><li class="breadcrumb-nav-list-item"><a href="/optimist/storage/s3_documentation/">S3 Compatible Object Storage</a><li class="breadcrumb-nav-list-item"><span>Secure Backups with Restic and Rclone</span></ol></nav><div id="main-content" class="main-content"><main><p>Restic is a very simple and powerful file-level backup solution, which is rapidly gaining popularity. It can be used in combination with S3 which makes it a great tool to use with Optimist.</p><h2 id="problem-statement"> <a href="#problem-statement" class="anchor-heading" aria-labelledby="problem-statement"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Problem statement</h2><p>When performing file-level backups of a node into S3, the backup software needs write permissions for the S3 bucket.</p><p>But if an attacker gains access to the machine, he can also destroy the backups in the bucket, since the S3 credentials are present on the compromised system.</p><p>The solution can be as simple as limiting the level of access of the backup software to the bucket. Unfortunately, this isn’t trivial with S3.</p><h2 id="background"> <a href="#background" class="anchor-heading" aria-labelledby="background"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Background</h2><p><a href="/optimist/storage/s3_documentation/security">S3 access control lists (ACLs)</a> enable you to manage access to buckets and objects, but they have limitations. They essentially differentiate READ and WRITE permissions:</p><ul><li>READ - Allows grantee to list the objects in the bucket<li>WRITE - Allows grantee to create, overwrite, and delete any object in the bucket</ul><p>The limitations of ACLs were addressed by the access policy permissions (ACP). We can attach a no-delete policy to the bucket, e.g.</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nodelete1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Deny"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"s3:DeleteBucket"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:DeleteBucketPolicy"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:DeleteBucketWebsite"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:DeleteObject"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:DeleteObjectVersion"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:s3:::*"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div><p>Unfortunately, the S3 protocol itself wasn’t designed with the concept of WORM (write once read many) backups in mind. Access policy permissions do not differentiate between changing an existing object (which would effectively allow deleting it) and creating a new object.</p><p>Attaching the above policy on a bucket does not prevent the objects in it from being overwritten.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>s3cmd put testfile s3://appendonly-bucket/testfile
upload: <span class="s1">'testfile'</span> -&gt; <span class="s1">'s3://appendonly-bucket/testfile'</span> <span class="o">[</span>1 of 1]
 1054 of 1054 100% <span class="k">in </span>0s 5.46 KB/s <span class="k">done</span>     <span class="c"># policy allows write</span>
<span class="nv">$ </span>s3cmd <span class="nb">rm </span>s3://appendonly-bucket/testfile
ERROR: S3 error: 403 <span class="o">(</span>AccessDenied<span class="o">)</span>         <span class="c"># policy denies deletion</span>
<span class="err">$</span>
<span class="nv">$ </span>s3cmd put testfile s3://appendonly-bucket/testfile
upload: <span class="s1">'testfile'</span> -&gt; <span class="s1">'s3://appendonly-bucket/testfile'</span> <span class="o">[</span>1 of 1]
 1054 of 1054 100% <span class="k">in </span>0s 5.50 KB/s <span class="k">done</span>     <span class="c"># :(</span>
</code></pre></div></div><h2 id="proposed-solution"> <a href="#proposed-solution" class="anchor-heading" aria-labelledby="proposed-solution"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Proposed solution</h2><p>Since an attacker on a compromised system will always have access to the S3 credentials and every service running on the system - including restic itself, proxies, etc. - we need a second, locked-down VM which can restrict delete operations. Restic can be integrated perfectly with rclone, so we’ll use it in this example.</p><h3 id="our-environment"> <a href="#our-environment" class="anchor-heading" aria-labelledby="our-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Our environment</h3><ul><li><code class="language-plaintext highlighter-rouge">appsrv</code>: the system which has access to the files we would like to backup<li><code class="language-plaintext highlighter-rouge">rclonesrv</code>: the system running the rclone proxy (and nothing else, to minimise the attack surface)</ul><h3 id="set-up-the-rclone-proxy"> <a href="#set-up-the-rclone-proxy" class="anchor-heading" aria-labelledby="set-up-the-rclone-proxy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Set up the rclone proxy</h3><ol><li><p>Install rclone on the <code class="language-plaintext highlighter-rouge">rclonesrv</code></p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>apt <span class="nb">install </span>rclone
</code></pre></div></div><li><p>Create user for rclone</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">sudo </span>useradd <span class="nt">-m</span> rcloneproxy
 <span class="nb">sudo </span>su - rcloneproxy
</code></pre></div></div><li><p>Create rclone backend configuration</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">mkdir</span> <span class="nt">-p</span> .config/rclone
 <span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; .config/rclone/rclone.conf
 [s3-resticrepo]
 type = s3
 provider = Other
 env_auth = false
 access_key_id = 111122223333444455556666
 secret_access_key = aaaabbbbccccddddeeeeffffgggghhhh
 region = eu-central-1
 endpoint = s3.es1.fra.optimist.gec.io
 acl = private
 bucket_acl = private
 upload_concurrency = 8
</span><span class="no"> EOF
</span></code></pre></div></div><li><p>Verify that the access to the repository is working with:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> rclone lsd s3-resticrepo:databucket
         0 2021-11-21 20:02:10        <span class="nt">-1</span> data
         0 2021-11-21 20:02:10        <span class="nt">-1</span> index
         0 2021-11-21 20:02:10        <span class="nt">-1</span> keys
         0 2021-11-21 20:02:10        <span class="nt">-1</span> snapshots
</code></pre></div></div></ol><h3 id="configure-the-appserver"> <a href="#configure-the-appserver" class="anchor-heading" aria-labelledby="configure-the-appserver"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configure the appserver</h3><ol><li><p>Generate an SSH-Keypair on <code class="language-plaintext highlighter-rouge">appsrv</code> with the user you’re performing the backup with:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh-keygen <span class="nt">-o</span> <span class="nt">-a</span> 256 <span class="nt">-t</span> ed25519 <span class="nt">-C</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">hostname</span><span class="si">)</span><span class="s2">-</span><span class="si">$(</span><span class="nb">date</span> +<span class="s1">'%d-%m-%Y'</span><span class="si">)</span><span class="s2">"</span>
</code></pre></div></div><li><p>Set the environment variables for restic:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">export </span><span class="nv">RESTIC_PASSWORD</span><span class="o">=</span><span class="s2">"MyV3ryS3cUr3r3571cP4ssW0rd"</span>
 <span class="nb">export </span><span class="nv">RESTIC_REPOSITORY</span><span class="o">=</span>rclone:s3-resticrepo:databucket
</code></pre></div></div></ol><h3 id="restrict-the-ssh-key-to-restic-only-commands"> <a href="#restrict-the-ssh-key-to-restic-only-commands" class="anchor-heading" aria-labelledby="restrict-the-ssh-key-to-restic-only-commands"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Restrict the SSH key to restic-only commands</h3><p>The last step is to go back to the <code class="language-plaintext highlighter-rouge">rclonesrv</code> and edit the SSH <code class="language-plaintext highlighter-rouge">authorized_keys</code> file to restrict the newly generated SSH key to a single command. This way, an attacker is not able to use the ssh keypair to run arbitrary commands on the rclone proxy and compromise the backups.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi ~/.ssh/authorized_keys
<span class="c"># add an entry with the restic user's public key generated in a previous step:</span>
<span class="nb">command</span><span class="o">=</span><span class="s2">"rclone serve restic --stdio --append-only s3-resticrepo:databucket"</span> ssh-ed25519 AAAAC3fdsC1lZddsDNTE5ADsaDgfTwNtWmwiocdT9q4hxcss6tGDfgGTdiNN0z7zN appsrv-18-11-2021
</code></pre></div></div><h2 id="using-restic-with-the-rclone-proxy"> <a href="#using-restic-with-the-rclone-proxy" class="anchor-heading" aria-labelledby="using-restic-with-the-rclone-proxy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using restic with the rclone proxy</h2><p>With the environment variables set, restic should work now from <code class="language-plaintext highlighter-rouge">appsrv</code>.</p><p>Example backing up <code class="language-plaintext highlighter-rouge">/srv/myapp</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>restic <span class="nt">-o</span> rclone.program<span class="o">=</span><span class="s2">"ssh rcloneproxy@rclonesrv.mydomain.com"</span> backup /srv/myapp
</code></pre></div></div><p>Listing snapshots:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>restic <span class="nt">-o</span> rclone.program<span class="o">=</span><span class="s2">"ssh rcloneproxy@rclonesrv.mydomain.com"</span> snapshots
</code></pre></div></div><p>Deleting snapshots:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>restic <span class="nt">-o</span> rclone.program<span class="o">=</span><span class="s2">"ssh rcloneproxy@rclonesrv.mydomain.com"</span> forget 2738e969
repository b71c391e opened successfully, password is correct
Remove<span class="o">(</span>&lt;snapshot/2738e9693b&gt;<span class="o">)</span> returned error, retrying after 446.577749ms: blob not removed, server response: 403 Forbidden <span class="o">(</span>403<span class="o">)</span>
</code></pre></div></div><p>Oh, right, that doesn’t work. That was our goal!</p><h2 id="summary"> <a href="#summary" class="anchor-heading" aria-labelledby="summary"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Summary</h2><p>This way,</p><ul><li>The rclone proxy doesn’t even run on the <code class="language-plaintext highlighter-rouge">rclonesrv</code> as a service. It will just be spawned on demand, for the duration of the restic operation. Communication happens over HTTP2 over stdin/stdout, in an encrypted SSH tunnel.<li>Since rclone is running with <code class="language-plaintext highlighter-rouge">--append-only</code>, it is not possible to delete (or overwrite) snapshots in the S3 bucket.<li>All data (except credentials) is encrypted/decrypted locally, then sent/received via <code class="language-plaintext highlighter-rouge">rclonesrv</code> to/from S3.<li>All the credentials are <strong>only</strong> stored on <code class="language-plaintext highlighter-rouge">rclonesrv</code> to communicate with S3.</ul><p>Since the command is hard-coded into the SSH configuration for the user’s SSH key, there is no way to use the the keys to get access to the rclone proxy.</p><h2 id="some-more-thoughts"> <a href="#some-more-thoughts" class="anchor-heading" aria-labelledby="some-more-thoughts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Some more thoughts</h2><p>The advantages of this construct are probably clear already by now. Furthermore,</p><ul><li>Managing snapshots (both manually and with a retention policy) is only possible on the rclone proxy.<li>A single rclone proxy VM (or even a docker container on an isolated VM) can serve multiple backup clients.<li>It is highly recommended to use one key for every server which backs up data.<li>If you’d like to use more than one repository out of a node, you’ll need new SSH keys for them. You can then specify which key to use with <code class="language-plaintext highlighter-rouge">-i ~/.ssh/id_ed25519_another_repo</code> in the <code class="language-plaintext highlighter-rouge">rclone.program</code> arguments just like you would with SSH.</ul></main><hr><footer> <br/><br/><br/><div class="footer-navigation-links"> <a class="footer-navigation-link footer-navigation-link--previous" href="/optimist/storage/s3_documentation/swiftservestaticwebsite/"> <svg class="footer-navigation-link__icon" viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> <span class="footer-navigation-link__sublabel">Previous</span> <span class="footer-navigation-link__label">Swift - Serving a Static Website</span> </a> <a class="footer-navigation-link footer-navigation-link--next" href="/optimist/storage/localstorage/"> <svg class="footer-navigation-link__icon" viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> <span class="footer-navigation-link__sublabel">Next</span> <span class="footer-navigation-link__label">Localstorage</span> </a></div><div class="footer-links"><div class=footer-hosted-with-love> <a href="https://github.com/gecio/gecio.github.io" target="_blank" rel="noopener noreferrer" >Hosted with love on GitHub</a></div><div class="footer-external-links"><ul><li class="footer-external-link"> <a href="https://gec.io" target="_blank" rel="noopener noreferrer" >Website</a ><li class="footer-external-link"> <a href="https://gec.io/impressum/" target="_blank" rel="noopener noreferrer" >Imprint</a ><li class="footer-external-link"> <a href="https://gec.io/datenschutz/" target="_blank" rel="noopener noreferrer" >Data Privacy</a ></ul></div></div></footer></div></div><div class="search-overlay"></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.6/dist/mermaid.min.js"></script> <script> var config = {} ; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
